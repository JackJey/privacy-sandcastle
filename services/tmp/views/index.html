<!--
 Copyright 2023 Google Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{title}}</title>
  </head>
  <body>
    <main>
      <h2>Enter a username</h2>
      <form id="form" method="POST" action="/auth/username">
        <div>
          <label id="username-label">username</label>
          <!-- TODO: Add passkeys to the browser autofill: Enable conditional UI. -->
          <input type="text" id="username" aria-labelledby="username-label" name="username" autocomplete="username webauthn" autofocus />
        </div>
        <!--
        <div>
          <label id="password-label">password</label>
          <input
            type="password"
            aria-labelledby="password-label"
            name="password"
            autocomplete="current-password"
            autofocus
          />
        </div>
        -->
        <input type="submit" value="Next" />
      </form>
      <script type="module">
        // TODO: Add passkeys to the browser autofill: Detect features, invoke WebAuthn, and enable a conditional UI.
        import { authenticate } from "/client.js"

        const $ = document.querySelector.bind(document)
        const form = $("#form")
        form.addEventListener("submit", async (e) => {
          e.preventDefault()
          const formData = new FormData(e.target)
          const username = formData.get("username")
          try {
            const res = await fetch("/auth/username", {
              method: "post",
              headers: {
                "content-type": "application/json"
              },
              body: JSON.stringify({ username })
            })
            const user = await res.json()
            console.log({ user })
            location.href = "/reauth"
          } catch (error) {
            console.error(error.message)
            alert(error)
          }
        })

        // TODO: Add passkeys to the browser autofill: Detect features, invoke WebAuthn, and enable a conditional UI.

        try {
          // Is WebAuthn available on this browser?
          // Is conditional UI available in this browser?
          const cma = await PublicKeyCredential.isConditionalMediationAvailable()
          if (cma === false) {
            alert("Conditional UI Not supported")
          } else {
            // If conditional UI is available, invoke the authenticate() function.
            const user = await authenticate()
            console.log({ user })
            if (user) {
              // Proceed only when authentication succeeds.
              $("#username").value = user.username
              location.href = "/home"
            } else {
              alert("User not found.")
            }
          }
        } catch (e) {
          // A NotAllowedError indicates that the user canceled the operation.
          if (e.name !== "NotAllowedError") {
            console.error(e)
            alert(e.message)
          }
        }
      </script>
    </main>
  </body>
</html>
